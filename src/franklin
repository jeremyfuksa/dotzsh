#!/usr/bin/env bash

# Franklin helper CLI that proxies to the core maintenance scripts.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRANKLIN_ROOT="${FRANKLIN_ROOT:-$SCRIPT_DIR}"
UPDATE_SCRIPT="$FRANKLIN_ROOT/update-all.sh"
FRANKLIN_UPDATE_SCRIPT="$FRANKLIN_ROOT/update-franklin.sh"
CHECK_SCRIPT="$FRANKLIN_ROOT/scripts/check_versions.sh"
VERSION_SCRIPT="$FRANKLIN_ROOT/scripts/current_franklin_version.sh"

log_error() {
  echo "franklin: $*" >&2
}

print_version() {
  if [ -n "${FRANKLIN_VERSION:-}" ]; then
    echo "$FRANKLIN_VERSION"
    return 0
  fi

  if [ -f "$VERSION_SCRIPT" ]; then
    bash "$VERSION_SCRIPT"
    return 0
  fi

  if [ -f "$FRANKLIN_ROOT/VERSION" ]; then
    cat "$FRANKLIN_ROOT/VERSION"
    return 0
  fi

  echo "unknown"
  return 0
}

run_update() {
  if [ ! -f "$UPDATE_SCRIPT" ]; then
    log_error "update script missing: $UPDATE_SCRIPT"
    return 2
  fi

  bash "$UPDATE_SCRIPT" "$@"
}

run_update_franklin_only() {
  if [ -f "$FRANKLIN_UPDATE_SCRIPT" ]; then
    bash "$FRANKLIN_UPDATE_SCRIPT" "$@"
    return $?
  fi

  if [ ! -f "$UPDATE_SCRIPT" ]; then
    log_error "update script missing: $UPDATE_SCRIPT"
    return 2
  fi

  bash "$UPDATE_SCRIPT" --franklin-only "$@"
}

run_check() {
  if [ ! -f "$CHECK_SCRIPT" ]; then
    log_error "version checker missing: $CHECK_SCRIPT"
    return 2
  fi

  bash "$CHECK_SCRIPT" "$@"
}

show_help() {
  cat <<'EOF'
Franklin Helper CLI

Usage: franklin [OPTIONS] COMMAND [ARGS...]

Options:
  -v, --version     Print Franklin version
  -h, --help        Show this help message

Commands:
  update            Update Franklin core files only
  update-all        Run the full unified update workflow
  check             Run the version checker (scripts/check_versions.sh)
  motd theme        Change MOTD banner theme (thick/thin/thin-double)
  motd preview      Preview current MOTD with current settings
  reload            Reload the shell configuration (exec zsh)
  version           Alias for --version
  help              Show this help text

Examples:
  franklin -v
  franklin update --quiet
  franklin check --json
  franklin motd theme
  franklin motd preview
EOF
}

if [ $# -eq 0 ]; then
  show_help
  exit 0
fi

while [ $# -gt 0 ]; do
  case "$1" in
    -v|--version)
      print_version
      exit 0
      ;;
    -h|--help)
      show_help
      exit 0
      ;;
    --)
      shift
      break
      ;;
    -*)
      log_error "Unknown option: $1"
      show_help >&2
      exit 2
      ;;
    *)
      break
      ;;
  esac
done

command="${1:-}"
shift || true

case "$command" in
  update)
    run_update_franklin_only "$@"
    ;;
  update-all)
    run_update "$@"
    ;;
  check)
    run_check "$@"
    ;;
  reload)
    echo "Reloading shell configuration..." >&2
    if command -v zsh >/dev/null 2>&1; then
      exec zsh -l
    else
      log_error "zsh not found in PATH"
      exit 2
    fi
    ;;
  version)
    print_version
    ;;
  motd)
    subcommand="${1:-}"
    shift || true
    case "$subcommand" in
      theme)
        THEME_PICKER="$FRANKLIN_ROOT/scripts/motd_theme_picker.sh"
        if [ -f "$THEME_PICKER" ]; then
          bash "$THEME_PICKER" "$@"
        else
          log_error "Theme picker script missing: $THEME_PICKER"
          exit 2
        fi
        ;;
      preview)
        # Source motd.env and run motd function
        MOTD_ENV="${FRANKLIN_CONFIG_DIR:-$HOME/.config/franklin}/motd.env"
        if [ -f "$MOTD_ENV" ]; then
          source "$MOTD_ENV"
        fi
        if command -v motd >/dev/null 2>&1; then
          motd
        else
          log_error "motd function not available. Try: source ~/.zshrc"
          exit 2
        fi
        ;;
      ""|help)
        cat <<'MOTD_HELP'
Franklin MOTD Management

Usage: franklin motd SUBCOMMAND [OPTIONS]

Subcommands:
  theme        Interactively change banner theme (thick/thin/thin-double)
  preview      Show current MOTD dashboard with current settings

Examples:
  franklin motd theme          # Interactive theme picker
  franklin motd preview        # Preview current MOTD
MOTD_HELP
        ;;
      *)
        log_error "Unknown motd subcommand: $subcommand"
        echo "Run 'franklin motd help' for usage." >&2
        exit 2
        ;;
    esac
    ;;
  help|"")
    show_help
    ;;
  *)
    log_error "Unknown command: $command"
    show_help >&2
    exit 2
    ;;
esac
